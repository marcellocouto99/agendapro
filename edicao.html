<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, doc, updateDoc, deleteDoc,
    query, where
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBihcx1ihMSs7egInoGOzV1mWIw9D8LUzw",
    authDomain: "agendapro-f6ecc.firebaseapp.com",
    projectId: "agendapro-f6ecc",
    storageBucket: "agendapro-f6ecc.firebasestorage.app",
    messagingSenderId: "1045418539073",
    appId: "1:1045418539073:web:aa920e129ece148c0feec0"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  onAuthStateChanged(auth, (user)=>{ if(!user) window.location.href="index.html"; });

  document.getElementById("logoutBtn").addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!confirm("Tem certeza que deseja sair da conta?")) return;
    await signOut(auth);
    window.location.href = "index.html";
  });

  const tbody = document.querySelector("#appointmentsTable tbody");
  const searchInput = document.getElementById("searchInput");
  const searchButton = document.getElementById("searchButton");
  const clearButton = document.getElementById("clearButton");

  let allRows = [];

  // ðŸ”¥ FunÃ§Ã£o para remover agendamentos antigos automaticamente
  async function cleanOldAppointments() {
    const today = new Date();
    today.setHours(0,0,0,0); // garante meia-noite

    const snap = await getDocs(collection(db, "agendamentos"));
    for (const d of snap.docs) {
      const data = d.data();
      if (data.dateISO) {
        const agendamentoDate = new Date(data.dateISO + "T00:00:00");
        if (agendamentoDate < today) {
          await deleteDoc(doc(db, "agendamentos", d.id));
          console.log("Apagado agendamento antigo:", d.id);
        }
      }
    }
  }

  async function loadAll(){
    tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

    // âœ… Primeiro limpa os antigos
    await cleanOldAppointments();

    // Depois carrega os atuais
    const snap = await getDocs(collection(db,"agendamentos"));
    allRows = [];
    snap.forEach(d=>{
      allRows.push({ id: d.id, ...d.data() });
    });
    renderTable(allRows);
  }

  function formatTime(t){
    if (!t || t.length!==4) return t||"";
    return `${t.slice(0,2)}:${t.slice(2)}`;
  }

  function formatDate(isoDate){
    if (!isoDate) return "";
    const [year, month, day] = isoDate.split("-");
    return `${day}/${month}/${year}`;
  }

  function renderTable(rows){
    if (!rows.length){
      tbody.innerHTML = "<tr><td colspan='6'>Nenhum agendamento encontrado.</td></tr>";
      return;
    }

    rows.sort((a, b) => {
      const dateA = new Date(`${a.dateISO}T${formatTime(a.time)}`);
      const dateB = new Date(`${b.dateISO}T${formatTime(b.time)}`);
      return dateA - dateB;
    });

    tbody.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.name || ""}</td>
        <td>${r.plate || ""}</td>
        <td>${r.store || ""}</td>
        <td>${formatDate(r.dateISO) || ""}</td>
        <td>${formatTime(r.time) || ""}</td>
        <td>
          <button class="edit-btn" data-edit="${r.id}">Editar</button>
          <button class="delete-btn" data-del="${r.id}">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Busca
  function doSearch(){
    const q = (searchInput.value || "").trim().toLowerCase();
    if (!q) { renderTable(allRows); return; }
    const filtered = allRows.filter(r =>
      (r.name||"").toLowerCase().includes(q) ||
      (r.plate||"").toLowerCase().includes(q) ||
      (r.store||"").toLowerCase().includes(q)
    );
    renderTable(filtered);
  }
  searchButton.addEventListener("click", doSearch);
  searchInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") {
      e.preventDefault();
      doSearch();
    }
  });
  clearButton.addEventListener("click", ()=>{ searchInput.value=""; renderTable(allRows); });

  // iniciar
  await loadAll();
</script>
