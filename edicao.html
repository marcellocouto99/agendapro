<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Editar Agendamentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="menu.css">
  <link rel="stylesheet" href="edicao.css">
</head>
<body>
  <div class="logo">
    <img src="img/LogoPitstop.png" alt="Logo" style="margin-top:20px;display:block;margin-inline:auto" width="200" height="200">
  </div>
  <h1 class="titulo">Editar Agendamentos</h1>
  <h6 class="subtitulo">Gerencie, altere ou exclua seus agendamentos</h6>

  <div class="container mt-4">
    <div class="search-section" style="display:flex; gap:8px; margin-bottom:12px;">
      <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome, placa ou loja">
      <button id="searchButton" class="btn btn-primary">Buscar</button>
      <button id="clearButton" class="btn btn-outline-secondary">Limpar</button>
    </div>
    <div class="table-responsive">
      <table id="appointmentsTable">
        <thead>
          <tr>
            <th>Nome</th><th>Placa</th><th>Loja</th><th>Data</th><th>Hora</th><th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal Edição -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h2>Editar Agendamento</h2>
      <form id="editForm">
        <div class="form-group">
          <label for="editName">Nome</label>
          <input type="text" id="editName" required class="form-control">
        </div>
        <div class="form-group">
          <label for="editPlate">Placa</label>
          <input type="text" id="editPlate" required class="form-control">
        </div>
        <div class="form-group">
          <label for="editStore">Loja</label>
          <input type="text" id="editStore" required class="form-control">
        </div>
        <div class="form-group">
          <label for="editDate">Data</label>
          <input type="date" id="editDate" required class="form-control">
        </div>
        <div class="form-group">
          <label for="editTime">Hora</label>
          <select id="editTime" required class="form-control">
            <option value="0900">09:00</option>
            <option value="1000">10:00</option>
            <option value="1100">11:00</option>
            <option value="1400">14:00</option>
            <option value="1500">15:00</option>
            <option value="1600">16:00</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-success">Salvar</button>
          <button type="button" id="cancelEdit" class="btn btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Menu Lateral -->
  <nav class="menu-lateral">
    <div class="btn-expandir"><i class="bi bi-list" id="btn-exp"></i></div>
    <ul>
      <li class="item-menu"><a href="calendario.html"><span class="icon"><i class="bi bi-calendar3"></i></span><span class="txt-link">Calendário</span></a></li>
      <li class="item-menu"><a href="agendamentos.html"><span class="icon"><i class="bi bi-file-earmark-check"></i></span><span class="txt-link">Agendamento</span></a></li>
      <li class="item-menu"><a href="#"><span class="icon"><i class="bi bi-gear"></i></span><span class="txt-link">Configuração</span></a></li>
      <li class="item-menu ativo"><a href="edicao.html"><span class="icon"><i class="bi bi-pencil-square"></i></span><span class="txt-link">Editar</span></a></li>
      <li class="item-menu"><a href="#"><span class="icon"><i class="bi bi-person-circle"></i></span><span class="txt-link">Conta</span></a></li>
      <li class="item-menu"><a href="#" id="logoutBtn"><span class="icon"><i class="bi bi-box-arrow-right"></i></span><span class="txt-link">Sair</span></a></li>
      <li class="logo-item">
        <span class="icon"><img src="img/LogoAgendaPro.png" alt="Logo AgendaPro" class="logo-agendapro"></span>
        <span class="logo-text">AgendaPro</span>
      </li>
    </ul>
  </nav>

  <!-- Firebase + Lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, updateDoc, deleteDoc,
      query, where
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBihcx1ihMSs7egInoGOzV1mWIw9D8LUzw",
      authDomain: "agendapro-f6ecc.firebaseapp.com",
      projectId: "agendapro-f6ecc",
      storageBucket: "agendapro-f6ecc.firebasestorage.app",
      messagingSenderId: "1045418539073",
      appId: "1:1045418539073:web:aa920e129ece148c0feec0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user)=>{ if(!user) window.location.href="index.html"; });

    document.getElementById("logoutBtn").addEventListener("click", async (e)=>{
      e.preventDefault();
      if (!confirm("Tem certeza que deseja sair da conta?")) return;
      await signOut(auth);
      window.location.href = "index.html";
    });

    const tbody = document.querySelector("#appointmentsTable tbody");
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const clearButton = document.getElementById("clearButton");

    let allRows = []; // cache em memória [{id, ...data}]

    async function loadAll(){
      tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";
      const snap = await getDocs(collection(db,"agendamentos"));
      allRows = [];
      snap.forEach(d=>{
        allRows.push({ id: d.id, ...d.data() });
      });
      renderTable(allRows);
    }

    function renderTable(rows){
      if (!rows.length){
        tbody.innerHTML = "<tr><td colspan='6'>Nenhum agendamento encontrado.</td></tr>";
        return;
      }
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name || ""}</td>
          <td>${r.plate || ""}</td>
          <td>${r.store || ""}</td>
          <td>${r.dateISO || ""}</td>
          <td>${formatTime(r.time) || ""}</td>
          <td>
            <button class="edit-btn" data-edit="${r.id}">Editar</button>
            <button class="delete-btn" data-del="${r.id}">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatTime(t){ // "0900" -> "09:00"
      if (!t || t.length!==4) return t||"";
      return `${t.slice(0,2)}:${t.slice(2)}`;
    }

    function unformatTime(t){ // "09:00" -> "0900"
      return t.replace(":","");
    }

    // Buscar (filtro local)
    function doSearch(){
      const q = (searchInput.value || "").trim().toLowerCase();
      if (!q) { renderTable(allRows); return; }
      const filtered = allRows.filter(r =>
        (r.name||"").toLowerCase().includes(q) ||
        (r.plate||"").toLowerCase().includes(q) ||
        (r.store||"").toLowerCase().includes(q)
      );
      renderTable(filtered);
    }
    searchButton.addEventListener("click", doSearch);
    clearButton.addEventListener("click", ()=>{ searchInput.value=""; renderTable(allRows); });

    // Editar / Excluir (delegação)
    tbody.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button");
      if (!btn) return;

      const idEdit = btn.getAttribute("data-edit");
      const idDel  = btn.getAttribute("data-del");

      if (idEdit){
        const row = allRows.find(r=>r.id===idEdit);
        if (!row) return;
        openEditModal(row);
      }
      if (idDel){
        if (!confirm("Excluir este agendamento?")) return;
        await deleteDoc(doc(db,"agendamentos", idDel));
        await loadAll();
        alert("Agendamento excluído.");
      }
    });

    // Modal edição
    const modal = document.getElementById("editModal");
    const closeModal = document.getElementById("closeModal");
    const cancelEdit = document.getElementById("cancelEdit");
    const editForm = document.getElementById("editForm");
    const editName = document.getElementById("editName");
    const editPlate = document.getElementById("editPlate");
    const editStore = document.getElementById("editStore");
    const editDate = document.getElementById("editDate");
    const editTime = document.getElementById("editTime");
    let editingId = null;

    function openEditModal(row){
      editingId = row.id;
      editName.value = row.name || "";
      editPlate.value = row.plate || "";
      editStore.value = row.store || "";
      editDate.value = row.dateISO || "";
      editTime.value = row.time || "0900";
      modal.style.display = "flex";
    }
    function closeEditModal(){ modal.style.display = "none"; editingId = null; }
    closeModal.addEventListener("click", closeEditModal);
    cancelEdit.addEventListener("click", closeEditModal);
    window.addEventListener("click",(e)=>{ if(e.target===modal) closeEditModal(); });

    editForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!editingId) return;
      // validação simples
      if (!editName.value || !editPlate.value || !editStore.value || !editDate.value || !editTime.value){
        alert("Preencha todos os campos."); return;
      }

      // impedir conflito: verifica se já existe alguém nesse mesmo slot
      const qSame = query(
        collection(db,"agendamentos"),
        where("dateISO","==", editDate.value),
        where("time","==", editTime.value)
      );
      const snapSame = await getDocs(qSame);
      const conflict = snapSame.docs.find(d=> d.id !== editingId);
      if (conflict){
        alert("Este horário já está ocupado para esta data.");
        return;
      }

      await updateDoc(doc(db,"agendamentos", editingId), {
        name: editName.value.trim(),
        plate: editPlate.value.trim().toUpperCase(),
        store: editStore.value.trim(),
        dateISO: editDate.value,
        time: editTime.value
      });
      closeEditModal();
      await loadAll();
      alert("Agendamento atualizado.");
    });

    // iniciar
    await loadAll();
  </script>

  <script src="menu.js"></script>
</body>
</html>
